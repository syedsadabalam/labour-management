{% extends "base.html" %}
{% block title %}Payments{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header -->
  <div class="row mb-3">
    <div class="col-8">
      <h4 class="mb-0">Payments</h4>
      <p class="text-muted small">Advance & payment history</p>
    </div>
    <div class="col-4 text-end">
      <a href="{{ url_for('admin_bp.admin_add_payment') }}"
         class="btn btn-sm btn-success">
        + Add Payment
      </a>
      <a href="{{ url_for('admin_bp.admin_dashboard') }}"
         class="btn btn-sm btn-outline-secondary ms-2">
        Dashboard
      </a>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end">

        <!-- Labour Name -->
        <div class="col-md-4">
          <label class="form-label small">Labour Name</label>
          <input type="text"
                name="labour"
                class="form-control"
                placeholder="e.g. Labour name"
                value="{{ request.args.get('labour','') }}">
        </div>

        <!-- Site -->
        <div class="col-md-4">
          <label class="form-label small">Site</label>
          <select name="site_id" class="form-select">
            <option value="">All Sites</option>
            {% for site in sites %}
              <option value="{{ site.id }}"
                {% if request.args.get('site_id') == site.id|string %}selected{% endif %}>
                {{ site.site_name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Month -->
        <div class="col-md-3">
          <label class="form-label small">Month</label>
          <input type="month"
                name="month"
                class="form-control"
                value="{{ request.args.get('month', current_month) }}">
        </div>

        <!-- Submit -->
        <div class="col-md-1 d-grid">
          <button class="btn btn-primary btn-sm">Filter</button>
        </div>

      </form>
    </div>
  </div>


  <!-- Table -->
  <div class="card">
    <div class="card-body p-0">
      {% if payments %}
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Date</th>
              <th>Labour</th>
              <th>Site</th>
              <th>Advance</th>
             
              <th>Note</th>
              <th style="width:180px">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in payments %}
            <tr>
              <td>
                {{ (pagination.page - 1) * pagination.per_page + loop.index }}
              </td>

              <td>{{ payment.date or '-' }}</td>

              <td>
                {{ payment.labour.name if payment.labour else '-' }}
              </td>

              <td>
                {{ payment.site.site_name if payment.site else '-' }}
              </td>

              <td>
                â‚¹{{ "%.2f"|format(payment.advance or 0) }}
              </td>


              <td>{{ payment.note or '-' }}</td>

             <td>
                <a href="{{ url_for('admin_bp.admin_edit_payment', payment_id=payment.id) }}"
                  class="btn btn-sm btn-outline-primary">Edit</a>

                <form action="{{ url_for('admin_bp.delete_payment', payment_id=payment.id) }}"
                      method="post" style="display:inline;">
                  <button type="submit"
                          class="btn btn-sm btn-danger"
                          onclick="return confirm('Delete this payment?')">
                    Delete
                  </button>
                </form>
              </td>

            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if pagination.pages > 1 %}
        <nav class="mt-3">
          <ul class="pagination justify-content-center pagination-sm">

            <!-- Previous -->
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('admin_bp.admin_payments',
                                  page=pagination.prev_num,
                                  labour=request.args.get('labour'),
                                  site_id=request.args.get('site_id'),
                                  month=request.args.get('month')) }}">
                Prev
              </a>
            </li>

            <!-- Page numbers -->
            {% for p in range(1, pagination.pages + 1) %}
              <li class="page-item {% if p == pagination.page %}active{% endif %}">
                <a class="page-link"
                  href="{{ url_for('admin_bp.admin_payments',
                                    page=p,
                                    labour=request.args.get('labour'),
                                    site_id=request.args.get('site_id'),
                                    month=request.args.get('month')) }}">
                  {{ p }}
                </a>
              </li>
            {% endfor %}

            <!-- Next -->
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
              <a class="page-link"
                href="{{ url_for('admin_bp.admin_payments',
                                  page=pagination.next_num,
                                  labour=request.args.get('labour'),
                                  site_id=request.args.get('site_id'),
                                  month=request.args.get('month')) }}">
                Next
              </a>
            </li>

          </ul>
        </nav>
        {% endif %}

      </div>
      {% else %}
        <div class="p-4 text-center text-muted">No payments recorded.</div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
