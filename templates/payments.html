{% extends "base.html" %}

{% block title %}Advance Payments{% endblock %}
{% block page_title %}Advance Payment Management{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- PAGE HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="fw-semibold text-dark mb-0">
      <i class="fa-solid fa-hand-holding-dollar me-2 text-success"></i>Advance Payments
    </h5>
    <a href="{{ url_for('manager_bp.add_payment') }}" class="btn btn-primary">
      <i class="fa-solid fa-plus me-2"></i>Add New Payment
    </a>
  </div>

  <!-- FILTER BAR -->
  <form method="GET" action="{{ url_for('manager_bp.payment_history') }}" class="row g-3 align-items-end mb-4">
    <div class="col-md-3">
      <label for="month" class="form-label fw-semibold">Select Month</label>
      <input type="month" id="month" name="month" value="{{ request.args.get('month', '') }}" class="form-control" />
    </div>

    <div class="col-md-4">
      <label for="search" class="form-label fw-semibold">Search Labour</label>
      <input type="text" id="search" name="search" class="form-control"
             placeholder="Enter labour name..." value="{{ request.args.get('search', '') }}">
    </div>

    <div class="col-md-5 d-flex gap-2">
      <button type="submit" class="btn btn-success">
        <i class="fa-solid fa-magnifying-glass"></i> Filter
      </button>
      <a href="{{ url_for('manager_bp.payment_history') }}" class="btn btn-outline-secondary">
        <i class="fa-solid fa-rotate-left"></i> Reset
      </a>
    </div>
  </form>

  <!-- SUMMARY CARD -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body d-flex align-items-center justify-content-between">
      <div>
        <h6 class="text-muted mb-1">Total Advance This Month</h6>
        <h4 class="fw-bold text-success mb-0">₹ {{ total_month_advance or 0 }}</h4>
      </div>
      <i class="fa-solid fa-sack-dollar fa-2x text-success opacity-75"></i>
    </div>
  </div>

  <!-- PAYMENTS TABLE -->
  <div class="card shadow-sm border-0">
    <div class="card-header bg-white border-bottom fw-semibold">
      Advance Payment History
    </div>

    <div class="card-body p-0">
      {% if payments %}
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Labour Name</th>
              <th>Phone</th>
              <th>Date</th>
              <th>Advance (₹)</th>
              <th>Note</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
              {% for payment in payments %}
              <tr {% if not payment.labour.is_active %}class="table-secondary"{% endif %}>
                <td>{{ loop.index }}</td>
                <td>
                  {{ payment.labour.name }}
                  {% if not payment.labour.is_active %}
                    <span class="badge bg-secondary ms-1">Inactive</span>
                  {% endif %}
                </td>
                <td>{{ payment.labour.phone }}</td>
                <td>{{ payment.date.strftime('%d-%m-%Y') }}</td>
                <td>₹{{ "%.2f"|format(payment.advance) }}</td>
                <td>{{ payment.note or '-' }}</td>
                <td>
                  <a href="{{ url_for('manager_bp.edit_payment', payment_id=payment.id) }}" class="btn btn-sm btn-primary">Edit</a>
                  <form action="{{ url_for('manager_bp.delete_payment', payment_id=payment.id) }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>

        </table>
      </div>
      {% else %}
      <div class="p-4 text-center text-muted">
        <i class="fa-solid fa-file-invoice-dollar fa-2x mb-2"></i>
        <p>No payment records found for the selected month or search term.</p>
      </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
