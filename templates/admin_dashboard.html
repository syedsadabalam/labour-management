{% extends "base.html" %}
{% block content %}

 <!-- ADMIN ACTION BAR -->
        <div class="card shadow-sm mb-4">
        <div class="card-body py-2">
            <div class="d-flex flex-wrap gap-2">

            <a href="{{ url_for('admin_bp.admin_sites') }}"
                class="btn btn-sm btn-outline-primary">
                ğŸ— Sites
            </a>

            <a href="{{ url_for('admin_bp.admin_managers') }}"
                class="btn btn-sm btn-outline-success">
                ğŸ‘¤ Managers
            </a>

            <a href="{{ url_for('admin_bp.monthly_report') }}"
                class="btn btn-sm btn-outline-info">
                ğŸ“Š Monthly Reports
            </a>

            <a href="{{ url_for('admin_bp.attendance_report') }}"
                class="btn btn-sm btn-outline-secondary">
                ğŸ•’ Attendance Report
            </a>

            <a href="{{ url_for('admin_bp.labour_salary_sheet') }}"
                class="btn btn-sm btn-outline-success">
                ğŸ’° Salary Sheet
            </a>

            <a href="{{ url_for('admin_bp.admin_audit_logs') }}"
                class="btn btn-sm btn-outline-dark">
                ğŸ§¾ Activity Logs
            </a>

            </div>
        </div>
        </div>

<div class="container-fluid mt-3">


  <!-- ================= TOP SYSTEM STATUS BAR ================= -->
  <div class="card mb-3 p-2 px-3 d-flex flex-row justify-content-between align-items-center">
    <div class="fw-semibold">
      ğŸ”¥ Attendance {{ dashboard.system_status.attendance_percent }}%
      &nbsp; | &nbsp;
      Sites Active {{ dashboard.system_status.active_sites }}/{{ dashboard.system_status.total_sites }}
      &nbsp; | &nbsp;
      Payroll {{ dashboard.system_status.payroll_state }}
    </div>

    {% if dashboard.system_status.alerts > 0 %}
      <span class="badge bg-danger">{{ dashboard.system_status.alerts }} Alerts</span>
    {% else %}
      <span class="badge bg-success">No Alerts</span>
    {% endif %}
  </div>

  <!-- ================= KPI ROW ================= -->
  <div class="row g-3 mb-4">


    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div class="text-muted small">Attendance Today</div>
        <h4 class="mb-0">{{ dashboard.system_status.attendance_percent }}%</h4>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div class="text-muted small">Active Sites</div>
        <h4 class="mb-0">
          {{ dashboard.system_status.active_sites }} / {{ dashboard.system_status.total_sites }}
        </h4>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div class="text-muted small">Payroll Exposure (MTD)</div>
        <h4 class="mb-0">â‚¹{{ dashboard.financial_risk.payroll_mtd }}</h4>
        <small class="text-muted">Advances {{ dashboard.financial_risk.ratio }}%</small>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 text-center">
        <div class="text-muted small">Critical Alerts</div>
        <h4 class="mb-0 text-danger">{{ dashboard.system_status.alerts }}</h4>
      </div>
    </div>

  </div>

  <!-- ================= MAIN GRID ================= -->
  <div class="row g-4">

    <!-- ================= LEFT COLUMN ================= -->
    <div class="col-lg-9">

      <!-- ACTION REQUIRED -->
      {% if dashboard.system_status.alerts > 0 %}
      <div class="card border-danger mb-4">
        <div class="card-body">
          <h6 class="text-danger mb-3">ğŸš¨ ACTION REQUIRED TODAY</h6>
          <ul class="mb-0">
            {% for site in dashboard.sites %}
              {% for alert in site.alerts %}
                <li><strong>{{ site.site_name }}</strong> â€” {{ alert }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}

      <!-- SITE OVERVIEW -->
      <h5 class="mb-3">Site Overview</h5>
      <div class="row g-3">

        {% for site in dashboard.sites %}
        <div class="col-md-4">
          <div class="card h-100">

            <div class="card-body">

              <!-- Header -->
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>{{ site.site_name }}</strong>

                {% if site.total_labours == 0 %}
                  <span class="badge bg-secondary">INACTIVE</span>
                {% elif site.status == 'CRITICAL' %}
                  <span class="badge bg-danger">âŒAttendance</span>
                {% elif site.status == 'DELAYED' %}
                  <span class="badge bg-warning text-dark"> âš ï¸Attendance Late</span>
                {% else %}
                  <span class="badge bg-success">âœ…Attendance</span>
                {% endif %}
              </div>

              <div class="text-muted small mb-2">
                Manager: {{ site.manager_name }}
              </div>

              <!-- Attendance -->
              <div class="fw-semibold mb-1">
                Attendance:
                {{ site.present_today }} / {{ site.total_labours }}
                ({{ site.attendance_percent }}%)
              </div>

              <!-- Payroll -->
              <div class="small text-muted mb-2">
                Payroll (MTD): â‚¹{{ site.payroll_mtd }} <br>
                Advances: â‚¹{{ site.total_advance }} ({{ site.advance_ratio }}%)
              </div>

              <!-- Alerts -->
              {% if site.alerts %}
              <ul class="small text-danger ps-3 mb-2">
                {% for a in site.alerts %}
                  <li>{{ a }}</li>
                {% endfor %}
              </ul>
              {% endif %}

              <a href="{{ url_for('admin_bp.admin_site_dashboard', site_id=site.site_id) }}" class="btn btn-sm btn-light w-100">View Site</a>
              <a href="{{ url_for('admin_bp.admin_monthly_attendance', site_id=site.site_id ) }}" class="btn btn-sm btn-light w-100">Monthly Attendance</a>


            </div>
          </div>
        </div>
        {% endfor %}

      </div>

    </div>

    <!-- ================= RIGHT COLUMN ================= -->
    <div class="col-lg-3">

      <!-- FINANCIAL RISK -->
      <div class="card mb-3">
        <div class="card-body">
          <h6>Financial Risk</h6>
          <ul class="small mb-0">
            <li>Advance / Payroll: {{ dashboard.financial_risk.ratio }}%</li>
            <li><strong>Total Payroll (MTD): â‚¹{{ dashboard.financial_risk.payroll_mtd }}</strong></li>
            <li><strong>Total Advances: â‚¹{{ dashboard.financial_risk.advances }}</strong></li>
          </ul>
        </div>
      </div>

      <!-- ATTENDANCE EXCEPTIONS -->
      <div class="card mb-3">
        <div class="card-body">
          <h6>Attendance Exceptions</h6>
          <ul class="small mb-0">
            {% if dashboard.attendance_exceptions %}
              {% for e in dashboard.attendance_exceptions %}
                <li>{{ e.site_name }} â€“ {{ e.attendance_percent }}%</li>
              {% endfor %}
            {% else %}
              <li>No attendance exceptions</li>
            {% endif %}
          </ul>
        </div>
      </div>

      <!-- MANAGERS -->
      <div class="card">
        <div class="card-body">
          <h6>Managers</h6>
          <ul class="small mb-0">
            {% for m in dashboard.managers %}
              <li>
                {{ m.manager }} ({{ m.site }}) â€“
                {% if m.status == 'Healthy' %}
                  ğŸŸ¢ Attendance Marked
                {% elif m.status == 'Delayed' %}
                  ğŸŸ¡ Attendance Late
                {% else %}
                  ğŸ”´ Attendance NOT Marked
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>

    </div>
  </div>

</div>
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">

{% endblock %}
